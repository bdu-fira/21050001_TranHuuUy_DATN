<!DOCTYPE html>
<html>
<head>
    <title>Công cụ phân tích mạng xã hội</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" type="text/css" href="/static/styles2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/static/logo.png" alt="Logo" class="logo">
            <h1>Bảng điều khiển <br class="mobile-break">Phân tích Cảm xúc</h1>
        </div>
        <div class="header-actions">
            <a href="/view_feedbacks" class="header-btn"><i class="fas fa-comments"></i> <span>Góp ý</span></a>
            <a href="/analysis_history" class="header-btn"><i class="fas fa-history"></i> <span>Lịch sử</span></a>
            <a href="/logout" class="header-btn btn-logout" title="Đăng xuất">
                <i class="fas fa-power-off"></i>
                <span class="logout-text">Đăng xuất</span>
            </a>
        </div>
    </header>

    <div class="main-container">
        <!-- Cột bên trái - Công cụ -->
        <div class="sidebar">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Phân tích Mạng xã hội</h2>
                </div>
                <div class="card-body">
                    <p>Chạy phân tích mới về các bình luận của trường Đại Học Bình Dương từ mạng xã hội.</p>
                    <form id="reviews-form">
                        <button type="submit" class="cta-button">Bắt đầu Phân tích</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-pen-alt"></i> Phân tích nhanh Văn bản</h2>
                </div>
                <div class="card-body">
                    <form id="predict-form">
                        <textarea name="text" rows="5" placeholder="Nhập văn bản cần phân tích ở đây..."></textarea>
                        <button type="submit">Phân tích ngay</button>
                    </form>
                    <div id="result" class="quick-analysis-result"></div>
                </div>
            </div>
        </div>

        <!-- Khu vực hiển thị kết quả chính -->
        <div class="content">
            <div id="reviews-result">
                {% if latest_report %}
                    <!-- 1. Đánh giá tổng quan -->
                    <div class="card summary-card">
                        <div class="card-header">
                            <h2 id="summary-title" data-timestamp="{{ latest_report.created_at }}">
                                <i class="fas fa-chart-bar"></i> Đánh giá Tổng quan
                            </h2>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-item stat-school"><h4>Trường</h4><p>Đại học Bình Dương</p></div>
                            <div class="stat-item"><h4>Tổng bình luận</h4><p>{{ latest_report.total_reviews }}</p></div>
                            <div class="stat-item"><h4>Nhận xét chung</h4><p class="sentiment-badge">{{ latest_report.avg_sentiment_type }}</p></div>
                        </div>
                    </div>

                    <!-- 2. Chỉ số Sức khỏe Thương hiệu -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <h3><i class="fas fa-heartbeat"></i> Net Sentiment Score (NSS)</h3>
                            <div class="metric-value 
                                {% if latest_report.nss > 0 %}nss-positive
                                {% elif latest_report.nss < 0 %}nss-negative
                                {% else %}nss-neutral{% endif %}">
                                {{ latest_report.nss }}
                            </div>
                        </div>
                        <div class="metric-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Tỷ lệ Tiêu cực</h3>
                            <div class="metric-value 
                                {% if latest_report.negative_ratio >= 20 %}ratio-danger
                                {% elif latest_report.negative_ratio >= 10 %}ratio-warning
                                {% else %}ratio-safe{% endif %}">
                                {{ latest_report.negative_ratio }}%
                            </div>
                        </div>
                    </div>

                    <!-- 3. Biểu đồ Xu hướng -->
                    {% if latest_report.sentiment_trend %}
                    <div class="card chart-card full-width">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Xu hướng Cảm xúc theo Thời gian</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- 4. Phân tích Chủ đề (GỘP) -->
                    {% if latest_report.strengths_to_promote or latest_report.improvement_suggestions %}
                    <div class="card chart-card full-width">
                        <div class="card-header"><h3><i class="fas fa-balance-scale"></i> Phân tích Chủ đề Khen / Phàn nàn</h3></div>
                        <div class="card-body">
                            <div class="chart-container" id="topic-chart-container" style="margin-bottom: 30px; display: none; height: 300px;">
                                <canvas id="topicComparisonChart"></canvas>
                            </div>
                    
                            {% if latest_report.strengths_to_promote %}
                            <div class="topic-section">
                                <h4 style="font-size: 18px; margin-bottom: 15px; color: #28a745;"><i class="fas fa-thumbs-up"></i> Điểm cần phát huy</h4>
                                <ul class="suggestions-list">
                                    {% for topic, data in latest_report.strengths_to_promote.items()|sort(attribute='1.count', reverse=True) %}
                                    {% if data.count > 5 %}
                                    <li class="suggestion-item">
                                        <div class="suggestion-header"><span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span><span class="suggestion-count strength-count">{{ data.count }} lượt khen</span></div>
                                        <div class="suggestion-examples" style="display: none;"><p><strong>Ví dụ:</strong></p><ul>{% for ex in data.examples %}<li>"{{ ex }}"</li>{% endfor %}</ul></div>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                    
                            {% if latest_report.improvement_suggestions %}
                             <div class="topic-section" style="margin-top: 30px;">
                                <h4 style="font-size: 18px; margin-bottom: 15px; color: #dc3545;"><i class="fas fa-wrench"></i> Gợi ý Cải thiện</h4>
                                <ul class="suggestions-list">
                                    {% for topic, data in latest_report.improvement_suggestions.items()|sort(attribute='1.count', reverse=True) %}
                                    {% if data.count > 5 %}
                                    <li class="suggestion-item">
                                        <div class="suggestion-header"><span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span><span class="suggestion-count">{{ data.count }} phàn nàn</span></div>
                                        <div class="suggestion-examples" style="display: none;"><p><strong>Ví dụ:</strong></p><ul>{% for ex in data.examples %}<li>"{{ ex }}"</li>{% endfor %}</ul></div>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 5. Các biểu đồ khác -->
                    <div class="charts-grid">
                        <div class="card chart-card">
                            <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Tỷ lệ Cảm xúc</h3></div>
                            <div class="card-body chart-container pie-chart-wrapper"><canvas id="sentimentPieChart"></canvas></div>
                        </div>
                        <div class="card chart-card">
                            <div class="card-header"><h3><i class="fas fa-circle-notch"></i> Biểu đồ Venn</h3></div>
                            <div class="card-body"><img src="data:image/png;base64,{{ latest_report.venn_diagram }}" alt="Biểu đồ Venn"></div>
                        </div>
                        <div class="card chart-card full-width">
                            <div class="card-header"><h3><i class="fas fa-cloud"></i> Word Cloud</h3></div>
                            <div class="card-body wordcloud-container">
                                <div class="wordcloud-item"><h4>Tích cực</h4><img src="data:image/png;base64,{{ latest_report.positive_wordcloud }}" alt="Word Cloud Tích cực"></div>
                                <div class="wordcloud-item"><h4>Trung tính</h4><img src="data:image/png;base64,{{ latest_report.neutral_wordcloud }}" alt="Word Cloud Trung tính"></div>
                                <div class="wordcloud-item"><h4>Tiêu cực</h4><img src="data:image/png;base64,{{ latest_report.negative_wordcloud }}" alt="Word Cloud Tiêu cực"></div>
                            </div>
                        </div>
                        <div class="card chart-card full-width">
                            <div class="card-header"><h3><i class="fas fa-stream"></i> Phân tích tần suất từ (2-grams)</h3></div>
                            <div class="card-body">
                                <div class="ngram-stacked-item"><img src="data:image/png;base64,{{ latest_report.positive_bigram_chart }}" alt="Bigram Tích cực"></div>
                                <div class="ngram-stacked-item"><img src="data:image/png;base64,{{ latest_report.neutral_bigram_chart }}" alt="Bigram Trung tính"></div>
                                <div class="ngram-stacked-item"><img src="data:image/png;base64,{{ latest_report.negative_bigram_chart }}" alt="Bigram Tiêu cực"></div>
                            </div>
                        </div>
                    </div>
            
                {% else %}
                <div class="card empty-state">
                    <i class="fas fa-poll-h"></i>
                    <h2>Chưa có dữ liệu phân tích</h2>
                    <p>Hãy bắt đầu một phiên phân tích mới để xem kết quả tại đây.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" style="display:none;">
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Đang xử lý, vui lòng chờ...</p>
        </div>
    </div>

    <script>
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
            }
        }
    });

    let errorCount = 0;
    const MAX_RETRIES = 20;

    // --- HÀM VẼ BIỂU ĐỒ BAR (CHỦ ĐỀ) ---
    function createTopicComparisonChart(strengthsData, suggestionsData, canvasId) {
        if (!strengthsData || !suggestionsData) return;
        const suggestionTopics = Object.keys(suggestionsData);
        const commonTopics = Object.keys(strengthsData).filter(topic => suggestionTopics.includes(topic));

        if (commonTopics.length > 0) {
            $(`#${canvasId}`).parent().show();
            const strengthCounts = commonTopics.map(topic => strengthsData[topic].count);
            const suggestionCounts = commonTopics.map(topic => suggestionsData[topic].count);

            new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: commonTopics,
                    datasets: [
                        { label: 'Lượt khen', data: strengthCounts, backgroundColor: '#28a745', borderColor: '#218838', borderWidth: 1 },
                        { label: 'Phàn nàn', data: suggestionCounts, backgroundColor: '#dc3545', borderColor: '#c82333', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Số lượng' } } },
                    plugins: { legend: { position: 'top' }, title: { display: true, text: 'So sánh Khen và Chê' } }
                }
            });
        }
    }

    // --- HÀM RENDER REVIEW ---
    function displayReviews(reviews) { 
        let reviewsHtml = ''; 
        if (!reviews || reviews.length === 0) { 
            reviewsHtml = '<p class="no-reviews">Không có dữ liệu.</p>'; 
        } else { 
            reviews.forEach(function(review) { 
                let sentimentClass = ''; 
                if (review.sentiment_type === 'Tích cực') sentimentClass = 'positive'; 
                else if (review.sentiment_type === 'Tiêu cực') sentimentClass = 'negative'; 
                else sentimentClass = 'neutral'; 
                
                reviewsHtml += `<div class="review-item"><div class="review-header"><span class="review-author"><i class="fas fa-user"></i> ${review.author}</span><span class="review-time"><i class="fas fa-clock"></i> ${review.rtime}</span></div><div class="review-body"><p>${review.text}</p></div><div class="review-footer"><span class="sentiment-type ${sentimentClass}">${review.sentiment_type}</span></div></div>`; 
            }); 
        } 
        $('#reviews-list').html(reviewsHtml); 
    }

    // --- HÀM RENDER KẾT QUẢ AJAX (Chính) ---
    function renderAnalysisResult(response) {
        let topicAnalysisHtml = '';
        const strengths = response.strengths_to_promote;
        const suggestions = response.improvement_suggestions;
        
        // Tạo HTML chủ đề
        if ((strengths && Object.keys(strengths).length > 0) || (suggestions && Object.keys(suggestions).length > 0)) {
            topicAnalysisHtml += `<div class="card chart-card full-width"><div class="card-header"><h3><i class="fas fa-balance-scale"></i> Phân tích Chủ đề Khen / Phàn nàn</h3></div><div class="card-body"><div class="chart-container" id="ajax-topic-chart-container" style="margin-bottom: 30px; display: none; height: 300px;"><canvas id="ajaxTopicComparisonChart"></canvas></div>`;
            if (strengths) {
                const sortedStrengths = Object.entries(strengths).filter(([, data]) => data.count > 5).sort(([, a], [, b]) => b.count - a.count);
                if (sortedStrengths.length > 0) {
                    topicAnalysisHtml += `<div class="topic-section"><h4 style="font-size: 18px; margin-bottom: 15px; color: #28a745;"><i class="fas fa-thumbs-up"></i> Điểm cần phát huy</h4><ul class="suggestions-list">`;
                    sortedStrengths.forEach(([topic, data]) => {
                        let examplesHtml = data.examples.map(ex => `<li>"${ex}"</li>`).join('');
                        topicAnalysisHtml += `<li class="suggestion-item"><div class="suggestion-header"><span class="suggestion-topic"><i class="fas fa-tag"></i> ${topic}</span><span class="suggestion-count strength-count">${data.count} khen</span></div><div class="suggestion-examples" style="display: none;"><p><strong>Ví dụ:</strong></p><ul>${examplesHtml}</ul></div></li>`;
                    });
                    topicAnalysisHtml += '</ul></div>';
                }
            }
            if (suggestions) {
                const sortedSuggestions = Object.entries(suggestions).filter(([, data]) => data.count > 5).sort(([, a], [, b]) => b.count - a.count);
                if (sortedSuggestions.length > 0) {
                    topicAnalysisHtml += `<div class="topic-section" style="margin-top: 30px;"><h4 style="font-size: 18px; margin-bottom: 15px; color: #dc3545;"><i class="fas fa-wrench"></i> Gợi ý Cải thiện</h4><ul class="suggestions-list">`;
                    sortedSuggestions.forEach(([topic, data]) => {
                        let examplesHtml = data.examples.map(ex => `<li>"${ex}"</li>`).join('');
                        topicAnalysisHtml += `<li class="suggestion-item"><div class="suggestion-header"><span class="suggestion-topic"><i class="fas fa-tag"></i> ${topic}</span><span class="suggestion-count">${data.count} phàn nàn</span></div><div class="suggestion-examples" style="display: none;"><p><strong>Ví dụ:</strong></p><ul>${examplesHtml}</ul></div></li>`;
                    });
                    topicAnalysisHtml += '</ul></div>';
                }
            }
            topicAnalysisHtml += '</div></div>';
        }

        let nssClass = response.nss > 0 ? 'nss-positive' : (response.nss < 0 ? 'nss-negative' : 'nss-neutral');
        let ratioClass = response.negative_ratio >= 20 ? 'ratio-danger' : (response.negative_ratio >= 10 ? 'ratio-warning' : 'ratio-safe');

        // Render HTML tổng thể
        let html = `
            <div class="card summary-card">
                <div class="card-header"><h2><i class="fas fa-chart-bar"></i> Đánh giá Tổng quan</h2></div>
                <div class="summary-stats">
                    <div class="stat-item stat-school"><h4>Trường</h4><p>Đại học Bình Dương</p></div>
                    <div class="stat-item"><h4>Tổng bình luận</h4><p>${response.total_reviews}</p></div>
                    <div class="stat-item"><h4>Nhận xét chung</h4><p class="sentiment-badge">${response.avg_sentiment_type}</p></div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3><i class="fas fa-heartbeat"></i> Net Sentiment Score (NSS)</h3>
                    <div class="metric-value ${nssClass}">${response.nss}</div>
                </div>
                <div class="metric-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Tỷ lệ Tiêu cực</h3>
                    <div class="metric-value ${ratioClass}">${response.negative_ratio}%</div>
                </div>
            </div>

            <!-- BIỂU ĐỒ XU HƯỚNG -->
            <div class="card chart-card full-width">
                <div class="card-header"><h3><i class="fas fa-chart-line"></i> Xu hướng Cảm xúc theo Thời gian</h3></div>
                <div class="card-body"><div class="chart-container" style="height: 350px;"><canvas id="trendChart"></canvas></div></div>
            </div>

            ${topicAnalysisHtml}
            
            <div class="charts-grid">
                <div class="card chart-card"><div class="card-header"><h3><i class="fas fa-chart-pie"></i> Tỷ lệ Cảm xúc</h3></div><div class="card-body chart-container pie-chart-wrapper"><canvas id="sentimentPieChart"></canvas></div></div>
                <div class="card chart-card"><div class="card-header"><h3><i class="fas fa-circle-notch"></i> Biểu đồ Venn</h3></div><div class="card-body"><img src="data:image/png;base64,${response.venn_diagram}" alt="Biểu đồ Venn"></div></div>
                <div class="card chart-card full-width"><div class="card-header"><h3><i class="fas fa-cloud"></i> Word Cloud</h3></div><div class="card-body wordcloud-container"><div class="wordcloud-item"><h4>Tích cực</h4><img src="data:image/png;base64,${response.positive_wordcloud}" alt="Word Cloud Tích cực"></div><div class="wordcloud-item"><h4>Trung tính</h4><img src="data:image/png;base64,${response.neutral_wordcloud}" alt="Word Cloud Trung tính"></div><div class="wordcloud-item"><h4>Tiêu cực</h4><img src="data:image/png;base64,${response.negative_wordcloud}" alt="Word Cloud Tiêu cực"></div></div></div>
                <div class="card chart-card full-width"><div class="card-header"><h3><i class="fas fa-stream"></i> Phân tích tần suất từ (2-grams)</h3></div><div class="card-body"><div class="ngram-stacked-item"><img src="data:image/png;base64,${response.positive_bigram_chart}" alt="Bigram Tích cực"></div><div class="ngram-stacked-item"><img src="data:image/png;base64,${response.neutral_bigram_chart}" alt="Bigram Trung tính"></div><div class="ngram-stacked-item"><img src="data:image/png;base64,${response.negative_bigram_chart}" alt="Bigram Tiêu cực"></div></div></div>
            </div>
            
            <div class="card reviews-card">
                <div class="card-header"><h3><i class="fas fa-list-ul"></i> Chi tiết Bình luận</h3><div class="filter-controls"><button class="filter-button active" data-filter="all">Tất cả</button><button class="filter-button" data-filter="Tích cực">Tích cực</button><button class="filter-button" data-filter="Trung tính">Trung tính</button><button class="filter-button" data-filter="Tiêu cực">Tiêu cực</button></div></div>
                <div id="reviews-list" class="card-body"></div>
            </div>`;

        $('#reviews-result').html(html);
        displayReviews(response.reviews);
        
        // Vẽ biểu đồ Pie
        new Chart(document.getElementById('sentimentPieChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Tích cực', 'Trung tính', 'Tiêu cực'],
                datasets: [{
                    data: [response.positive_count, response.neutral_count, response.negative_count],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'], borderColor: '#fff', borderWidth: 2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } }, layout: { padding: 0 } }
        });

        // Vẽ biểu đồ Bar chủ đề
        createTopicComparisonChart(response.strengths_to_promote, response.improvement_suggestions, 'ajaxTopicComparisonChart');

        // VẼ BIỂU ĐỒ XU HƯỚNG
        if (response.sentiment_trend) {
            new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: response.sentiment_trend.labels,
                    datasets: [
                        { label: 'Tích cực', data: response.sentiment_trend.pos, borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Tiêu cực', data: response.sentiment_trend.neg, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Trung tính', data: response.sentiment_trend.neu, borderColor: '#ffc107', borderWidth: 1, borderDash: [5, 5], tension: 0.3, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: 'Diễn biến theo tháng' } }
                }
            });
        }

        // Sự kiện lọc review
        $('.filter-button').off('click').on('click', function() { 
            $('.filter-button').removeClass('active'); 
            $(this).addClass('active'); 
            const filter = $(this).data('filter'); 
            if (filter === 'all') displayReviews(response.reviews); 
            else displayReviews(response.reviews.filter(r => r.sentiment_type === filter)); 
        });
    }

    // --- POLLING FUNCTION ---
    function pollTaskStatus(taskId) {
        $.ajax({
            url: '/check_status/' + taskId,
            type: 'GET', timeout: 30000,
            success: function(response) {
                errorCount = 0;
                if (response.status === 'processing') {
                    $('.loading-overlay p').html('Đang xử lý...<br><small style="font-size: 13px; color: #666;">(Vui lòng không tắt trình duyệt)</small>');
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                } else if (response.status === 'completed') {
                    renderAnalysisResult(response.result);
                    $('#loading').hide();
                } else if (response.status === 'failed') {
                    $('#loading').hide();
                    alert('Lỗi: ' + response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 404) { $('#loading').hide(); alert('Phiên hết hạn, thử lại.'); return; }
                errorCount++;
                if (errorCount <= MAX_RETRIES) {
                    $('.loading-overlay p').html(`Mất kết nối (${errorCount}/${MAX_RETRIES})... Đang thử lại...`);
                    setTimeout(() => pollTaskStatus(taskId), 3000);
                } else {
                    $('#loading').hide();
                    alert('Mất kết nối server quá lâu.');
                }
            }
        });
    }

    $(document).ready(function() {
        // Format ngày giờ header
        const summaryTitle = $('#summary-title');
        if (summaryTitle.length) {
            const date = new Date(summaryTitle.data('timestamp'));
            const str = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')} - ${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
            summaryTitle.html(`<i class="fas fa-chart-bar"></i> Đánh giá Tổng quan <small>(${str})</small>`);
        }
        
        // --- RENDER DỮ LIỆU TĨNH (Jinja2) ---
        {% if latest_report %}
            new Chart(document.getElementById('sentimentPieChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Tích cực', 'Trung tính', 'Tiêu cực'],
                    datasets: [{
                        data: [ {{ latest_report.positive_count }}, {{ latest_report.neutral_count }}, {{ latest_report.negative_count }} ],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'], borderColor: '#fff', borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } }, layout: { padding: 0 } }
            });
            
            const initStrengths = {{ latest_report.strengths_to_promote | tojson | safe }};
            const initSuggestions = {{ latest_report.improvement_suggestions | tojson | safe }};
            createTopicComparisonChart(initStrengths, initSuggestions, 'topicComparisonChart');

            // Render biểu đồ xu hướng tĩnh
            {% if latest_report.sentiment_trend %}
            var trendData = {{ latest_report.sentiment_trend | tojson | safe }};
            new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [
                        { label: 'Tích cực', data: trendData.pos, borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Tiêu cực', data: trendData.neg, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                        { label: 'Trung tính', data: trendData.neu, borderColor: '#ffc107', borderWidth: 1, borderDash: [5, 5], tension: 0.3, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { y: { beginAtZero: true } }
                }
            });
            {% endif %}
        {% endif %}

        // Form phân tích nhanh
        $('#predict-form').submit(function(e) {
            e.preventDefault();
            $('#result').html('<p class="loading-text"><i class="fas fa-spinner fa-spin"></i> Đang phân tích...</p>');
            $.post('/predict', $(this).serialize(), function(res) {
                let cls = res.sentiment_type === 'Tích cực' ? 'sentiment-positive' : (res.sentiment_type === 'Tiêu cực' ? 'sentiment-negative' : 'sentiment-neutral');
                $('#result').html(`<div class="quick-review ${cls}"><strong>Kết quả:</strong> ${res.sentiment_type}</div>`);
            });
        });
        
        // Form Crawl data
        $('#reviews-form').submit(function(e) {
            e.preventDefault();
            errorCount = 0;
            $('#loading').show();
            $('.loading-overlay p').text('Đang khởi tạo...');
            $('#reviews-result').empty();

            $.post('/get_reviews', $(this).serialize())
                .done(function(res) {
                    if (res.status === 'processing') pollTaskStatus(res.task_id);
                })
                .fail(function() {
                    $('#loading').hide();
                    alert("Lỗi khởi tạo.");
                });
        });

        $('#reviews-result').on('click', '.suggestion-header', function() {
            $(this).siblings('.suggestion-examples').slideToggle('fast');
        });
    });
    </script>
</body>
</html>