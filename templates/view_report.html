<!DOCTYPE html>
<html>
<head>
    <title>Chi tiết phân tích - {{ report.place_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" type="text/css" href="/static/styles2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- CSS TÙY CHỈNH RIÊNG CHO MOBILE CỦA TRANG NÀY -->
    <style>
        @media (max-width: 768px) {
            .stat-school {
                display: none;
            }

            .header-actions {
                justify-content: center !important; 
                width: 100%;
                background-color: transparent !important;
                padding: 0 !important;
            }

            .header-actions .header-btn {
                flex: none !important;
                width: auto !important;
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                
                background-color: #e8f0fe !important;
                color: #1674E6 !important;
                border-radius: 20px !important;
                padding: 8px 20px !important;
                font-weight: bold;
                font-size: 14px !important;
                white-space: nowrap;
                margin: 0 !important;
            }
            
            .header-actions .header-btn i {
                margin-right: 8px !important;
                font-size: 14px !important;
            }

            .main-container {
                padding: 10px !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/static/logo.png" alt="Logo" class="logo">
            <h1>Chi tiết Phân tích</h1>
        </div>
        <div class="header-actions">
            <a href="/analysis_history" class="header-btn">
                <i class="fas fa-arrow-left"></i> Quay về
            </a>
        </div>
    </header>

    <!-- Bố cục chính cho trang chi tiết -->
    <div class="main-container">
        <div class="content">
            <!-- Thẻ Đánh giá Tổng quan -->
            <div class="card summary-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Đánh giá Tổng quan <small>({{ report.created_at }})</small></h2>
                </div>
                <div class="summary-stats">
                    <div class="stat-item stat-school">
                        <h4>Trường</h4>
                        <p>Đại học Bình Dương</p>
                    </div>
                    <div class="stat-item">
                        <h4>Tổng bình luận</h4>
                        <p>{{ report.total_reviews }}</p>
                    </div>
                    <div class="stat-item">
                        <h4>Nhận xét chung</h4>
                        <p class="sentiment-badge">{{ report.avg_sentiment_type }}</p>
                    </div>
                </div>
            </div>
            
            <!-- === CARD PHÂN TÍCH CHỦ ĐỀ (GỘP) === -->
            {% if report.strengths_to_promote or report.improvement_suggestions %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-balance-scale"></i> Phân tích Chủ đề Khen / Chê</h3>
                </div>
                <div class="card-body">
                    <!-- Biểu đồ cột so sánh -->
                    <div class="chart-container" id="topic-chart-container" style="margin-bottom: 30px; display: none; height: 300px;">
                        <canvas id="topicComparisonChart"></canvas>
                    </div>

                    <!-- Điểm cần phát huy -->
                    {% if report.strengths_to_promote %}
                    <div class="topic-section">
                        <h4 style="font-size: 18px; margin-bottom: 15px; color: var(--positive-color);"><i class="fas fa-thumbs-up"></i> Điểm cần phát huy</h4>
                        <ul class="suggestions-list">
                            {% for topic, data in report.strengths_to_promote.items()|sort(attribute='1.count', reverse=True) %}
                            {% if data.count >= 2 %}
                            <li class="suggestion-item">
                                <div class="suggestion-header">
                                    <span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span>
                                    <span class="suggestion-count strength-count">{{ data.count }} lượt khen</span>
                                </div>
                                <div class="suggestion-examples" style="display: none;">
                                    <p><strong>Một số ví dụ:</strong></p>
                                    <ul>
                                        {% for ex in data.examples %}
                                        <li>"{{ ex }}"</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Gợi ý Cải thiện -->
                    {% if report.improvement_suggestions %}
                    <div class="topic-section" style="margin-top: 30px;">
                         <h4 style="font-size: 18px; margin-bottom: 15px; color: var(--negative-color);"><i class="fas fa-wrench"></i> Gợi ý Cải thiện</h4>
                        <ul class="suggestions-list">
                            {% for topic, data in report.improvement_suggestions.items()|sort(attribute='1.count', reverse=True) %}
                            {% if data.count >= 3 %}
                            <li class="suggestion-item">
                                <div class="suggestion-header">
                                    <span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span>
                                    <span class="suggestion-count">{{ data.count }} phàn nàn</span>
                                </div>
                                <div class="suggestion-examples" style="display: none;">
                                    <p><strong>Một số ví dụ:</strong></p>
                                    <ul>
                                        {% for ex in data.examples %}
                                        <li>"{{ ex }}"</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Lưới chứa các biểu đồ -->
            <div class="charts-grid">
                <!-- Biểu đồ tròn -->
                <div class="card chart-card">
                    <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Tỷ lệ Cảm xúc</h3></div>
                    <div class="card-body chart-container pie-chart-wrapper">
                        <canvas id="sentimentPieChart"></canvas>
                    </div>
                </div>

                <!-- Biểu đồ Venn -->
                <div class="card chart-card">
                    <div class="card-header"><h3><i class="fas fa-circle-notch"></i> Biểu đồ Venn</h3></div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ report.venn_diagram }}" alt="Biểu đồ Venn">
                    </div>
                </div>

                <!-- Word Cloud -->
                <div class="card chart-card full-width">
                    <div class="card-header"><h3><i class="fas fa-cloud"></i> Word Cloud</h3></div>
                    <div class="card-body wordcloud-container">
                        <div class="wordcloud-item">
                            <h4>Tích cực</h4>
                            <img src="data:image/png;base64,{{ report.positive_wordcloud }}" alt="Word Cloud Tích cực">
                        </div>
                        <div class="wordcloud-item">
                            <h4>Trung tính</h4>
                            <img src="data:image/png;base64,{{ report.neutral_wordcloud }}" alt="Word Cloud Trung tính">
                        </div>
                        <div class="wordcloud-item">
                            <h4>Tiêu cực</h4>
                            <img src="data:image/png;base64,{{ report.negative_wordcloud }}" alt="Word Cloud Tiêu cực">
                        </div>
                    </div>
                </div>

                <!-- Phân tích N-grams -->
                <div class="card chart-card full-width">
                    <div class="card-header">
                        <h3><i class="fas fa-stream"></i> Phân tích tần suất từ (2-grams)</h3>
                    </div>
                    <div class="card-body">
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.positive_bigram_chart }}" alt="Bigram Tích cực">
                        </div>
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.neutral_bigram_chart }}" alt="Bigram Trung tính">
                        </div>
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.negative_bigram_chart }}" alt="Bigram Tiêu cực">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // --- KHỞI TẠO BIỂU ĐỒ TRÒN ---
        var ctx = document.getElementById('sentimentPieChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Tích cực', 'Trung tính', 'Tiêu cực'],
                datasets: [{
                    data: [
                        {{ report.positive_count }},
                        {{ report.neutral_count }},
                        {{ report.negative_count }}
                    ],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 10 }
                    }
                },
                layout: { padding: 0 }
            }
        });

        // --- JAVASCRIPT CHO ACCORDION GỢI Ý ---
        $('.suggestion-header').on('click', function() {
            $(this).siblings('.suggestion-examples').slideToggle('fast');
        });

        // --- LOGIC MỚI CHO BIỂU ĐỒ SO SÁNH CHỦ ĐỀ ---
        function createTopicComparisonChart() {
            const strengthsData = {{ report.strengths_to_promote | tojson | safe }};
            const suggestionsData = {{ report.improvement_suggestions | tojson | safe }};
            
            if (!strengthsData || !suggestionsData) return;
    
            const suggestionTopics = Object.keys(suggestionsData);
            const commonTopics = Object.keys(strengthsData).filter(topic => suggestionTopics.includes(topic));
    
            if (commonTopics.length > 0) {
                $('#topic-chart-container').show(); // Show the chart container
    
                const labels = commonTopics;
                const strengthCounts = commonTopics.map(topic => strengthsData[topic].count);
                const suggestionCounts = commonTopics.map(topic => suggestionsData[topic].count);
    
                const ctx = document.getElementById('topicComparisonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Lượt khen',
                                data: strengthCounts,
                                backgroundColor: '#28a745',
                                borderColor: '#218838',
                                borderWidth: 1
                            },
                            {
                                label: 'Phàn nàn',
                                data: suggestionCounts,
                                backgroundColor: '#dc3545',
                                borderColor: '#c82333',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Số lượng'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'So sánh Khen và Chê'
                            }
                        }
                    }
                });
            }
        }
    
        createTopicComparisonChart();
    });
    </script>
</body>
</html>