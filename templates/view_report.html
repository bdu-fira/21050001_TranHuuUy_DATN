<!DOCTYPE html>
<html>
<head>
    <title>Chi tiết phân tích - {{ report.place_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" type="text/css" href="/static/styles2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        /* Ghi đè riêng cho nút Back trên mobile của trang này */
        @media (max-width: 768px) {
            .header-actions {
                justify-content: center !important; 
            }

            .header-actions .header-btn {
                flex: 0 0 auto !important;
                width: auto !important;
                padding: 8px 25px !important;
                border-radius: 20px !important;
                font-size: 14px !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/static/logo.png" alt="Logo" class="logo">
            <h1>Chi tiết Phân tích</h1>
        </div>
        <div class="header-actions">
            <a href="/analysis_history" class="header-btn">
                <i class="fas fa-arrow-left"></i> Quay về
            </a>
        </div>
    </header>

    <div class="main-container">
        <div class="content">
            <!-- 1. Đánh giá Tổng quan -->
            <div class="card summary-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Đánh giá Tổng quan <small>({{ report.created_at }})</small></h2>
                </div>
                <div class="summary-stats">
                    <div class="stat-item stat-school">
                        <h4>Trường</h4>
                        <p>Đại học Bình Dương</p>
                    </div>
                    <div class="stat-item">
                        <h4>Tổng bình luận</h4>
                        <p>{{ report.total_reviews }}</p>
                    </div>
                    <div class="stat-item">
                        <h4>Nhận xét chung</h4>
                        <p class="sentiment-badge">{{ report.avg_sentiment_type }}</p>
                    </div>
                </div>
            </div>

            <!-- 2. Chỉ số Sức khỏe Thương hiệu -->
            <div class="metrics-grid">
                <!-- Net Sentiment Score -->
                <div class="metric-card">
                    <h3><i class="fas fa-heartbeat"></i> Net Sentiment Score (NSS)</h3>
                    <div class="metric-value 
                        {% if report.nss > 0 %}nss-positive
                        {% elif report.nss < 0 %}nss-negative
                        {% else %}nss-neutral{% endif %}">
                        {{ report.nss }}
                    </div>
                </div>

                <!-- Tỷ lệ Tiêu cực -->
                <div class="metric-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Tỷ lệ Tiêu cực</h3>
                    <div class="metric-value 
                        {% if report.negative_ratio >= 20 %}ratio-danger
                        {% elif report.negative_ratio >= 10 %}ratio-warning
                        {% else %}ratio-safe{% endif %}">
                        {{ report.negative_ratio }}%
                    </div>
                </div>
            </div>

            <!-- 3. Biểu đồ Xu hướng -->
            {% if report.sentiment_trend %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Xu hướng Cảm xúc theo Thời gian</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 4. Phân tích Chủ đề -->
            {% if report.strengths_to_promote or report.improvement_suggestions %}
            <div class="card chart-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-balance-scale"></i> Phân tích Chủ đề Khen / Phàn nàn</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container" id="topic-chart-container" style="margin-bottom: 30px; display: none; height: 300px;">
                        <canvas id="topicComparisonChart"></canvas>
                    </div>

                    {% if report.strengths_to_promote %}
                    <div class="topic-section">
                        <h4 style="font-size: 18px; margin-bottom: 15px; color: #28a745;"><i class="fas fa-thumbs-up"></i> Điểm cần phát huy</h4>
                        <ul class="suggestions-list">
                            {% for topic, data in report.strengths_to_promote.items()|sort(attribute='1.count', reverse=True) %}
                            {% if data.count >= 5 %}
                            <li class="suggestion-item">
                                <div class="suggestion-header">
                                    <span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span>
                                    <span class="suggestion-count strength-count">{{ data.count }} lượt khen</span>
                                </div>
                                <div class="suggestion-examples" style="display: none;">
                                    <p><strong>Ví dụ:</strong></p>
                                    <ul>
                                        {% for ex in data.examples %}
                                        <li>"{{ ex }}"</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if report.improvement_suggestions %}
                    <div class="topic-section" style="margin-top: 30px;">
                         <h4 style="font-size: 18px; margin-bottom: 15px; color: #dc3545;"><i class="fas fa-wrench"></i> Gợi ý Cải thiện</h4>
                        <ul class="suggestions-list">
                            {% for topic, data in report.improvement_suggestions.items()|sort(attribute='1.count', reverse=True) %}
                            {% if data.count >= 5 %}
                            <li class="suggestion-item">
                                <div class="suggestion-header">
                                    <span class="suggestion-topic"><i class="fas fa-tag"></i> {{ topic }}</span>
                                    <span class="suggestion-count">{{ data.count }} phàn nàn</span>
                                </div>
                                <div class="suggestion-examples" style="display: none;">
                                    <p><strong>Ví dụ:</strong></p>
                                    <ul>
                                        {% for ex in data.examples %}
                                        <li>"{{ ex }}"</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 5. Các biểu đồ khác (Pie, Venn, Wordcloud) -->
            <div class="charts-grid">
                <div class="card chart-card">
                    <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Tỷ lệ Cảm xúc</h3></div>
                    <div class="card-body chart-container pie-chart-wrapper">
                        <canvas id="sentimentPieChart"></canvas>
                    </div>
                </div>

                <div class="card chart-card">
                    <div class="card-header"><h3><i class="fas fa-circle-notch"></i> Biểu đồ Venn</h3></div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ report.venn_diagram }}" alt="Biểu đồ Venn">
                    </div>
                </div>

                <div class="card chart-card full-width">
                    <div class="card-header"><h3><i class="fas fa-cloud"></i> Word Cloud</h3></div>
                    <div class="card-body wordcloud-container">
                        <div class="wordcloud-item">
                            <h4>Tích cực</h4>
                            <img src="data:image/png;base64,{{ report.positive_wordcloud }}" alt="Word Cloud Tích cực">
                        </div>
                        <div class="wordcloud-item">
                            <h4>Trung tính</h4>
                            <img src="data:image/png;base64,{{ report.neutral_wordcloud }}" alt="Word Cloud Trung tính">
                        </div>
                        <div class="wordcloud-item">
                            <h4>Tiêu cực</h4>
                            <img src="data:image/png;base64,{{ report.negative_wordcloud }}" alt="Word Cloud Tiêu cực">
                        </div>
                    </div>
                </div>

                <div class="card chart-card full-width">
                    <div class="card-header">
                        <h3><i class="fas fa-stream"></i> Phân tích tần suất từ (2-grams)</h3>
                    </div>
                    <div class="card-body">
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.positive_bigram_chart }}" alt="Bigram Tích cực">
                        </div>
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.neutral_bigram_chart }}" alt="Bigram Trung tính">
                        </div>
                        <div class="ngram-stacked-item">
                            <img src="data:image/png;base64,{{ report.negative_bigram_chart }}" alt="Bigram Tiêu cực">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // --- 1. BIỂU ĐỒ TRÒN ---
        var ctx = document.getElementById('sentimentPieChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Tích cực', 'Trung tính', 'Tiêu cực'],
                datasets: [{
                    data: [{{ report.positive_count }}, {{ report.neutral_count }}, {{ report.negative_count }}],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } },
                layout: { padding: 0 }
            }
        });

        // --- 2. ACCORDION ---
        $('.suggestion-header').on('click', function() {
            $(this).siblings('.suggestion-examples').slideToggle('fast');
        });

        // --- 3. BIỂU ĐỒ SO SÁNH CHỦ ĐỀ ---
        function createTopicComparisonChart() {
            const strengthsData = {{ report.strengths_to_promote | tojson | safe }};
            const suggestionsData = {{ report.improvement_suggestions | tojson | safe }};
            if (!strengthsData || !suggestionsData) return;
    
            const commonTopics = Object.keys(strengthsData).filter(topic => Object.keys(suggestionsData).includes(topic));
    
            if (commonTopics.length > 0) {
                $('#topic-chart-container').show();
                const strengthCounts = commonTopics.map(topic => strengthsData[topic].count);
                const suggestionCounts = commonTopics.map(topic => suggestionsData[topic].count);
    
                new Chart(document.getElementById('topicComparisonChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: commonTopics,
                        datasets: [
                            { label: 'Lượt khen', data: strengthCounts, backgroundColor: '#28a745', borderColor: '#218838', borderWidth: 1 },
                            { label: 'Phàn nàn', data: suggestionCounts, backgroundColor: '#dc3545', borderColor: '#c82333', borderWidth: 1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Số lượng' } } },
                        plugins: { legend: { position: 'top' }, title: { display: true, text: 'So sánh Khen và Chê' } }
                    }
                });
            }
        }
        createTopicComparisonChart();

        // --- 4. BIỂU ĐỒ XU HƯỚNG (LINE CHART) ---
        {% if report.sentiment_trend %}
        var ctxTrend = document.getElementById('trendChart').getContext('2d');
        var trendData = {{ report.sentiment_trend | tojson | safe }};
        
        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [
                    { label: 'Tích cực', data: trendData.pos, borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                    { label: 'Tiêu cực', data: trendData.neg, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', borderWidth: 2, tension: 0.3, fill: true },
                    { label: 'Trung tính', data: trendData.neu, borderColor: '#ffc107', borderWidth: 1, borderDash: [5, 5], tension: 0.3, fill: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { title: { display: true, text: 'Diễn biến số lượng bình luận theo tháng' } },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Số lượng' } }, x: { title: { display: true, text: 'Thời gian' } } }
            }
        });
        {% endif %}
    });
    </script>
</body>
</html>